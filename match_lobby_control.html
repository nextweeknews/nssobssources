<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Match Lobby Control</title>

<style>
  body {
    background:#0f172a;
    font-family:Inter, system-ui, sans-serif;
    color:#e9eef8;
    padding:22px;
  }
  h1 {font-size:38px;text-align:center;margin-bottom:18px;}
  button,input {
    font-size:24px;
    padding:14px;
    border-radius:12px;
    border:none;
    cursor:pointer;
  }
  input {width:100%;margin-bottom:8px;}
  .player-row,.result-row {
    background:rgba(255,255,255,0.08);
    border-radius:12px;
    margin-bottom:10px;
    padding:12px 16px;
    font-size:22px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .tracked {
    background:rgba(52,211,153,0.30);
    box-shadow:0 0 18px rgba(16,185,129,0.3);
  }
  .remove-btn {
    background:#ef4444!important;
    padding:10px 20px!important;
    font-weight:700;
  }
  .refresh-btn {
    background:#10b981;
    width:100%;
    margin-top:10px;
    font-size:26px;
  }
  .error-msg {color:#f87171;font-size:20px;margin-top:8px;}
</style>
</head>

<body>
<h1>Match Lobby Control</h1>

<div id="passwordBox">
  <input id="pw" type="password" placeholder="Enter PIN (7466)">
  <button onclick="submitPW()">OK</button>
  <div id="pwError" class="error-msg"></div>
</div>

<div id="ui" style="display:none">
  <input id="search" placeholder="Search by ID or name…" oninput="searchPlayers()" autocomplete="off" />
  <div id="error" class="error-msg"></div>

  <h2>Results</h2>
  <div id="searchResults"></div>

  <h2>Lobby</h2>
  <div id="lobbyList"></div>

  <button class="refresh-btn" onclick="refreshOverlay()">Refresh Overlay</button>
</div>

<script>
const API_URL="https://blue-dust-07fa.nextweekmedia.workers.dev/lobby";
const LB_URL="https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const CLIENT_ID="DISCORD|1069003073311211601";

let password=sessionStorage.getItem("lobbyPIN")||"";
let leaderboard=[];
let resolvedPlayers={};

async function init(){
  if(password){
    hidePWBox();
    await loadLeaderboard();
    await refreshLobby();
  }else{
    showPWBox();
  }
}

function showPWBox(){
  document.getElementById("passwordBox").style.display="block";
  document.getElementById("ui").style.display="none";
}
function hidePWBox(){
  document.getElementById("passwordBox").style.display="none";
  document.getElementById("ui").style.display="block";
}

async function submitPW(){
  const v=document.getElementById("pw").value.trim();
  if(!v)return;
  password=v;
  sessionStorage.setItem("lobbyPIN",password);
  hidePWBox();
  await loadLeaderboard();
  await refreshLobby();
}

async function loadLeaderboard(){
  const res = await fetch(LB_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      leaderboard:"season_10",
      rating_type:"player_global_all",
      client_id:CLIENT_ID
    })
  });
  const data = await res.json();
  leaderboard=data.leaderboard||[];
  resolvedPlayers=data.resolved?.players||{};
}

function nameOf(id){
  const p=resolvedPlayers[id]||{};
  return p.display_name||p.username||`Player ${id}`;
}

function showError(m){
  const e=document.getElementById("error");
  e.textContent=m;
  setTimeout(()=>e.textContent="",3000);
}

async function refreshLobby(){
  const state=await (await fetch(API_URL)).json();
  renderLobby(state);
}

function renderLobby(state){
  const box=document.getElementById("lobbyList");
  box.innerHTML="";

  const players = Array.isArray(state.players) ? state.players : [];

  const rows = players.map(id=>{
    const e=leaderboard.find(x=>String(x.team?.[0])===String(id))||{};
    return{
      id,
      name:nameOf(id),
      elo:e?.elo??0,
      tracked:state.tracked===String(id)
    };
  }).sort((a,b)=>(b.elo??0)-(a.elo??0));

  rows.forEach(r=>{
    const row=document.createElement("div");
    row.className=`player-row${r.tracked?" tracked":""}`;
    row.innerHTML=`
      <span>${r.name} (Elo ${Math.round(r.elo)})</span>
      <span style="display:flex;gap:6px">
        <button onclick="setTracked('${r.id}')">${r.tracked?"Untrack":"Track"}</button>
        <button class="remove-btn" onclick="removePlayer('${r.id}')">X</button>
      </span>`;
    box.appendChild(row);
  });
}

async function postState(newPlayers,newTracked,{doRefresh}={doRefresh:true}){
  const body = {
    password,
    players: newPlayers,
    tracked: newTracked ?? "",
    refresh: doRefresh
  };

  const res = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });

  if(!res.ok){
    sessionStorage.removeItem("lobbyPIN");
    password="";
    showPWBox();
    showError("PIN expired — re-enter");
    return;
  }

  await refreshLobby();
}

async function removePlayer(id){
  const state=await (await fetch(API_URL)).json();
  const players = Array.isArray(state.players) ? state.players.slice() : [];
  const newPlayers = players.filter(x=>String(x)!==String(id));
  const newTracked = (state.tracked===id ? "" : state.tracked);
  await postState(newPlayers,newTracked,{doRefresh:true});
}

async function setTracked(id){
  const state=await (await fetch(API_URL)).json();
  const players = Array.isArray(state.players) ? state.players.slice() : [];
  const newTracked = (state.tracked===id ? "" : id);
  await postState(players,newTracked,{doRefresh:true});
}

async function searchPlayers(){
  const q=document.getElementById("search").value.trim();
  const s=document.getElementById("searchResults");
  s.innerHTML="";
  if(!q)return;

  // Direct ID search
  if(/^\d+$/.test(q)) {
    return addResult(q,s);
  }

  const lc=q.toLowerCase();
  leaderboard
    .filter(e=>nameOf(e.team?.[0]).toLowerCase().includes(lc))
    .slice(0,10)
    .forEach(e=>addResult(e.team?.[0],s));
}

function addResult(id,box){
  const e=leaderboard.find(x=>String(x.team?.[0])===String(id))||{};
  const elo=e.elo!=null?Math.round(e.elo):"—";
  const div=document.createElement("div");
  div.className="result-row";
  div.innerHTML=`
    <span>${nameOf(id)} (Elo ${elo})</span>
    <button onclick="addPlayer('${id}')">Add</button>`;
  box.appendChild(div);
}

async function addPlayer(id){
  const state=await (await fetch(API_URL)).json();
  const players = Array.isArray(state.players) ? state.players.slice() : [];

  if(players.includes(id)) return;
  if(players.length>=8) return showError("Max 8 players");

  players.push(id);
  await postState(players,state.tracked,{doRefresh:true});
}

async function refreshOverlay(){
  const state=await (await fetch(API_URL)).json();
  const players = Array.isArray(state.players) ? state.players.slice() : [];
  await postState(players,state.tracked,{doRefresh:true});
  showError("Overlay refresh ✔");
}

init();
</script>
</body>
</html>
