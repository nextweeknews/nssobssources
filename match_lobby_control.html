<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Match Lobby Control</title>

<style>
  body {
    background:#0f172a;
    font-family:Inter, system-ui, sans-serif;
    color:#e9eef8;
    padding:22px;
  }

  h1 {
    font-size:38px;
    text-align:center;
    margin-bottom:18px;
  }

  button,input {
    font-size:24px;
    padding:14px;
    border-radius:12px;
    border:none;
    cursor:pointer;
  }

  input {
    width:60%;
    margin-bottom:8px;
  }

  .player-row,
  .result-row {
    background:rgba(255,255,255,0.08);
    border-radius:12px;
    margin-bottom:10px;
    padding:12px 16px;
    font-size:22px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    transition:background 0.22s ease, box-shadow 0.22s ease;
  }

  .player-row:hover {
    background:rgba(255,255,255,0.12);
  }

  /* Tracked highlight */
  .tracked {
    background:rgba(52, 211, 153, 0.35) !important;
    box-shadow:0 0 20px rgba(16,185,129,0.4);
  }

  .shared-btn {
    padding:10px 20px !important;
    font-weight:700;
    min-width:60px;
    color:#ffffff !important;
  }

  /* REMOVE BUTTON (X) */
  .remove-btn {
    background:#dc2626 !important;
  }
  .remove-btn:hover {
    background:#ef4444 !important;
  }

  /* ADD BUTTON (+) */
  .add-btn {
    background:#00643c !important;
  }
  .add-btn:hover {
    background:#008c50 !important;
  }

  /* REFRESH BUTTON */
  .refresh-btn {
    background:#00643c;
    color:#ffffff;
    width:100%;
    margin-top:10px;
    font-size:26px;
  }
  .refresh-btn:hover {
    background:#008c50;
  }

  .error-msg {
    color:#f87171;
    font-size:20px;
    margin-top:8px;
    text-align:center;
  }
</style>
</head>

<body>
<h1>Match Lobby Control</h1>

<input id="search" placeholder="Search by ID or nameâ€¦" oninput="searchPlayers()" autocomplete="off" />
<div id="error" class="error-msg"></div>

<h2>Results</h2>
<div id="searchResults"></div>

<h2>Lobby</h2>
<div id="lobbyList"></div>

<button class="refresh-btn" onclick="refreshOverlay()">Refresh Overlay</button>

<script>
const API_URL="https://blue-dust-07fa.nextweekmedia.workers.dev/lobby";
const LB_URL="https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const CLIENT_ID="DISCORD|1069003073311211601";

// <-- Your player ID (always in lobby + always tracked)
const MY_ID = "702730732220579950";

let leaderboard=[];
let resolvedPlayers={};

function hasMyId(players){
  return players.some(p => String(p) === MY_ID);
}

// Initialize
(async()=>{ await loadLeaderboard(); await refreshLobby(); })();

async function loadLeaderboard(){
  const res = await fetch(LB_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      leaderboard:"season_10",
      rating_type:"player_global_all",
      client_id:CLIENT_ID
    })
  });
  
  const data = await res.json();
  leaderboard=data.leaderboard||[];
  resolvedPlayers=data.resolved?.players||{};
}

function nameOf(id){
  const p = resolvedPlayers[id] || {};
  return p.display_name || p.username || `Player ${id}`;
}

function showError(m){
  const e=document.getElementById("error");
  e.textContent=m;
  setTimeout(()=>e.textContent="",2000);
}

async function refreshLobby(){
  const state = await (await fetch(API_URL)).json();

  // Ensure MY_ID is always present and tracked in backend state
  const players = state.players.slice();
  let needsUpdate = false;

  if (!hasMyId(players)) {
    players.push(MY_ID);
    needsUpdate = true;
  }

  if (String(state.tracked) !== MY_ID) {
    needsUpdate = true;
  }

  if (needsUpdate) {
    await postState(players, MY_ID, { refresh: true });
    return; // postState will call refreshLobby again
  }

  renderLobby(state);
}

function renderLobby(state){
  const box=document.getElementById("lobbyList");
  box.innerHTML="";

  const rows = state.players.map(id=>{
    const entry = leaderboard.find(x=>String(x.team?.[0])===String(id)) || {};
    return {
      id,
      name:nameOf(id),
      elo:entry?.elo ?? 0,
      tracked:String(state.tracked)===String(id)
    };
  }).sort((a,b)=>b.elo - a.elo);

  rows.forEach(r=>{
    const row=document.createElement("div");
    row.className=`player-row ${r.tracked?"tracked":""}`;

    const isMe = String(r.id) === MY_ID;

    // No remove button for MY_ID
    const controls = isMe
      ? ""
      : `<button class="remove-btn shared-btn" onclick="event.stopPropagation();removePlayer('${r.id}')">-</button>`;

    row.innerHTML=`
      <span>${r.name} (${Math.round(r.elo)})</span>
      ${controls}
    `;

    // Support both mouse + touch input
    row.addEventListener("click",()=>setTracked(r.id));
    row.addEventListener("touchstart",()=>setTracked(r.id),{passive:true});

    box.appendChild(row);
  });
}

async function postState(players,tracked,{refresh}={}){
  // Enforce MY_ID invariant on every state write
  if (!hasMyId(players)) players.push(MY_ID);
  tracked = MY_ID; // always keep you as the tracked player

  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ players, tracked, refresh })
  });
  await refreshLobby();
}

async function removePlayer(id){
  // Can't remove yourself
  if (String(id) === MY_ID) return;

  const state = await (await fetch(API_URL)).json();
  const players = state.players.filter(x=>String(x)!==String(id));
  await postState(players,state.tracked,{refresh:true});
}

async function setTracked(id){
  // Ignore which row was clicked; always keep MY_ID tracked
  const state = await (await fetch(API_URL)).json();
  const players = state.players.slice();
  if (!hasMyId(players)) players.push(MY_ID);
  await postState(players, MY_ID, {refresh:true});
}

async function searchPlayers(){
  const q=document.getElementById("search").value.trim();
  const s=document.getElementById("searchResults");
  s.innerHTML="";
  if(!q) return;

  // ID-only search
  if(/^\d+$/.test(q)) return addSearchResult(q,s);

  const results = leaderboard
    .filter(e=>nameOf(e.team?.[0]).toLowerCase().includes(q.toLowerCase()))
    .slice(0,10);

  results.forEach(e=>addSearchResult(e.team?.[0],s));
}

function addSearchResult(id,box){
  const entry=leaderboard.find(x=>String(x.team?.[0])===String(id))||{};
  const elo = entry.elo!=null ? Math.round(entry.elo) : "â€”";

  const div=document.createElement("div");
  div.className="result-row";
  div.innerHTML=`
    <span>${nameOf(id)} (${elo})</span>
    <button class="add-btn shared-btn" onclick="addPlayer('${id}')">+</button>
  `;
  box.appendChild(div);
}

async function addPlayer(id){
  const state = await (await fetch(API_URL)).json();

  if (state.players.some(x => String(x) === String(id))) return;
  if (state.players.length >= 8 && !hasMyId(state.players)) return showError("Max 8 players");

  state.players.push(id);
  await postState(state.players, state.tracked, { refresh:true });

  // ðŸ”½ Reset search box + results, keep it active
  const input = document.getElementById("search");
  const results = document.getElementById("searchResults");

  if (input) {
    input.value = "";
    input.focus();
  }
  if (results) {
    results.innerHTML = "";
  }
}

async function refreshOverlay(){
  const state = await (await fetch(API_URL)).json();
  await postState(state.players,state.tracked,{refresh:true});
  showError("Overlay refreshed");
}
</script>
</body>
</html>
