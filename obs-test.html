<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Elo + Rank</title>

<style>
html, body {
  height:100%;
  margin:0;
  background: transparent;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
}

.card {
  width:600px;
  height:200px;
  background: rgba(28,28,28,0.95);
  border-radius:24px;
  display:flex;
  flex-direction:row;
  justify-content:space-between;
  align-items:center;
  padding:0 20px;
  text-align:center;
  color:#e9eef8;
}

.section-rank {
  width:40%;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.section-elo {
  width:60%;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.label {
  font-size:26px;
  color:#bcd4ff;
  font-weight:600;
  margin-bottom:4px;
}

.metric {
  font-size:80px;
  font-weight:700;
  line-height:1;
  white-space:nowrap;
}

.delta {
  font-size:28px;
  font-weight:600;
  opacity:0;
  pointer-events:none;
  display:inline-flex;
  align-items:center;
  margin-top:4px;
  transition:opacity 0.4s ease, transform 0.4s ease;
}

.delta-positive { color:#4ade80; }
.delta-negative { color:#f87171; }
.delta-arrow { margin-right:4px; }
</style>
</head>

<body>
<div class="card">
  <div class="section-rank">
    <div class="label">Rank</div>
    <span id="rankNumber" class="metric">—</span>
    <span id="rankDelta" class="delta"><span class="delta-arrow"></span><span class="delta-number"></span></span>
  </div>

  <div class="section-elo">
    <div class="label">ELO</div>
    <span id="eloNumber" class="metric">—</span>
    <span id="eloDelta" class="delta"><span class="delta-arrow"></span><span class="delta-number"></span></span>
  </div>
</div>

<script>
const WORKER_URL = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const REFRESH_MS = 15000;

const eloEl = document.getElementById("eloNumber");
const rankEl = document.getElementById("rankNumber");
const eloDeltaEl = document.getElementById("eloDelta");
const rankDeltaEl = document.getElementById("rankDelta");
const arrowElo = eloDeltaEl.querySelector(".delta-arrow");
const numberElo = eloDeltaEl.querySelector(".delta-number");
const arrowRank = rankDeltaEl.querySelector(".delta-arrow");
const numberRank = rankDeltaEl.querySelector(".delta-number");

let lastElo = null;
let lastRank = null;

function getPlayerId() {
  const params = new URLSearchParams(location.search);
  return params.get("player_id") || "702730732220579950";
}

function animateDelta(el, arrow, number, oldVal, newVal, reverse=false) {
  const diff = newVal - oldVal;
  if (diff === 0 || oldVal === null) return;

  arrow.textContent = diff > 0 ? (reverse ? '▼' : '▲') : (reverse ? '▲' : '▼');
  number.textContent = Math.abs(diff);

  el.classList.remove("delta-positive","delta-negative");
  el.classList.add(diff > 0 ^ reverse ? "delta-positive" : "delta-negative");

  el.style.opacity = "0";
  el.style.transform = "translateY(8px)";
  requestAnimationFrame(() => {
    el.style.opacity = "1";
    el.style.transform = "translateY(0)";
  });
  
  setTimeout(() => el.style.opacity = "0", 8000);
}

async function fetchData() {
  const pid = getPlayerId();

  try {
    const resp = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        leaderboard: "season_10",
        rating_type: "player_global_all",
        client_id: "DISCORD|1069003073311211601"
      })
    });

    const data = await resp.json();
    const entries = data.leaderboard || [];
    const idx = entries.findIndex(p => p.team[0] === pid);

    if (idx < 0) return;

    const player = entries[idx];
    const newElo = player.elo || 0;
    const newRank = idx + 1;

    if (lastElo !== null && newElo !== lastElo)
      animateDelta(eloDeltaEl, arrowElo, numberElo, lastElo, newElo);

    if (lastRank !== null && newRank !== lastRank)
      animateDelta(rankDeltaEl, arrowRank, numberRank, lastRank, newRank, true);

    eloEl.textContent = newElo;
    rankEl.textContent = newRank;

    lastElo = newElo;
    lastRank = newRank;
  }
  catch(e) {
    console.error("Leaderboard error:", e);
  }
}

fetchData();
setInterval(fetchData, REFRESH_MS);
</script>

</body>
</html>
