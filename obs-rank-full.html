<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Season 10 Rankings</title>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: transparent;
      font-family: Inter, system-ui, sans-serif;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    .card {
      width: 1720px;
      height: 880px; /* Fixed */
      background: rgba(15,23,42,1);
      border-radius: 20px;
      padding: 32px 40px;
      display: flex;
      flex-direction: column;
      color: #e9eef8;
      box-shadow: 0 32px 32px rgba(0,0,0,0.65);
      box-sizing: border-box;
    }

    .title {
      font-size: 46px;
      font-weight: 900;
      color: #c7d7ff;
      text-align: center;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: .035em;
      flex-shrink: 0;
    }

    .header-row, .entry {
      display: grid;
      grid-template-columns: 120px 1fr 160px 150px 150px;
      align-items: center;
    }

    .header-row {
      height: 46px;
      margin-bottom: 10px;
      border-radius: 10px;
      background: rgba(148,163,184,0.12);
      font-size: 20px;
      font-weight: 700;
      color: #9ca3c7;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .header-row span:nth-child(2) {
      text-align: left;
      padding-left: 18px;
    }

    #resultsList {
      flex-shrink: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: opacity .3s ease, gap .3s ease;
      overflow: hidden;
    }

    .entry {
      height: 56px;
      font-size: 26px;
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      transition: background .25s ease, box-shadow .25s ease;
    }

    .place {
      font-size: 28px;
      font-weight: 900;
      text-align: center;
    }

    .player-name {
      font-size: 24px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-left: 24px;
      padding-right: 24px;
    }

    .elo-value, .stat-value {
      font-size: 26px;
      font-weight: 800;
      text-align: center;
    }

    .gold { color: #ffd700; }
    .silver { color: #c0c0c0; }
    .bronze { color: #cd7f32; }

    /* Subtle 1px column borders */
    .entry > span {
      border-right: 1px solid rgba(255,255,255,0.12);
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .entry > span:nth-child(2) { justify-content: flex-start; }
    .entry > span:last-child { border-right: none; }

    /* Tracked player highlight */
    .entry.highlight-gold {
      background: rgba(255,215,0,0.23);
      box-shadow: 0 0 14px rgba(255,215,0,0.25);
    }

    .entry.highlight-silver {
      background: rgba(192,192,192,0.23);
      box-shadow: 0 0 14px rgba(192,192,192,0.25);
    }

    .entry.highlight-bronze {
      background: rgba(205,127,50,0.23);
      box-shadow: 0 0 14px rgba(205,127,50,0.25);
    }

    .entry.highlight-default {
      background: rgba(52,211,153,0.23);
      box-shadow: 0 0 14px rgba(16,185,129,0.25);
    }

    .loading, .error {
      width: 100%;
      text-align: center;
      font-size: 28px;
    }
  </style>
</head>

<body>
<div class="card" id="card">
  <div class="title">Season 10 Rankings</div>

  <div class="header-row">
    <span>Rank</span>
    <span>Player</span>
    <span>Elo</span>
    <span>Wins</span>
    <span>Win Rate</span>
  </div>

  <div id="resultsList">
    <div class="loading">Loading…</div>
  </div>
</div>

<script>
const LB_URL="https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const CLIENT_ID="DISCORD|1069003073311211601";
const REFRESH_MS=15000;
const PLAYER_ID=new URLSearchParams(location.search).get("player_id");

const MAX_ROWS=16;
const SLICE_ROWS=15;
const ROW_H=56;
const TITLE_H=46+16;
const HEADER_H=46+10;
const CARD_H=880;

let last=null;

function adjust(rowCount){
  const content=rowCount*ROW_H;
  const remain=CARD_H - TITLE_H - HEADER_H - content;
  const gaps=Math.max(0,rowCount-1);
  const gap=Math.max(4,(remain*0.33)/gaps);
  const pad=(remain-(gap*gaps))/2;

  document.getElementById("resultsList").style.gap=`${gap}px`;
  const c=document.getElementById("card");
  c.style.paddingTop=`${32+pad}px`;
  c.style.paddingBottom=`${40+pad}px`;
}

function render(list){
  const el=document.getElementById("resultsList");
  el.innerHTML="";
  list.forEach(p=>{
    const r=document.createElement("div");
    r.className="entry";

    const c=p.rank===1?"gold":p.rank===2?"silver":p.rank===3?"bronze":"";
    if(String(p.id)===String(PLAYER_ID)){
      r.classList.add(
        p.rank===1?"highlight-gold":
        p.rank===2?"highlight-silver":
        p.rank===3?"highlight-bronze":
        "highlight-default"
      );
    }

    r.innerHTML=`
      <span class="place ${c}">${p.rank}</span>
      <span class="player-name">${p.name}</span>
      <span class="elo-value">${p.elo}</span>
      <span class="stat-value">${p.wins}</span>
      <span class="stat-value">${p.winRate!=null?p.winRate+"%":"—"}</span>
    `;
    el.appendChild(r);
  });
  adjust(list.length);
}

function normalize(data){
  return data.map((e,i)=>{
    const id=e.team[0];
    const wins=e.count_placement_1??0;
    const m=e.matches??0;
    return{
      rank:i+1,
      id,
      name:data.resolved?.players?.[id]?.display_name || `Player ${id}`,
      elo:Math.round(e.elo??0),
      wins,
      winRate:m>0?Math.round((wins/m)*100):null
    };
  });
}

function subset(list){
  const idx=list.findIndex(p=>String(p.id)===PLAYER_ID);
  if(idx<0) return list.slice(0,MAX_ROWS);
  if(list[idx].rank<=MAX_ROWS) return list.slice(0,MAX_ROWS);

  const start=Math.min(
    Math.max(idx-Math.floor(SLICE_ROWS/2),0),
    list.length-SLICE_ROWS
  );
  return list.slice(start,start+SLICE_ROWS);
}

async function tick(){
  try{
    const r=await fetch(LB_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        leaderboard:"season_10",
        rating_type:"player_global_all",
        client_id:CLIENT_ID
      })
    });
    const j=await r.json();
    const sorted=[...j.leaderboard].sort((a,b)=>(b.elo??0)-(a.elo??0));
    sorted.resolved=j.resolved;

    const mapped=normalize(sorted);
    const view=subset(mapped);

    if(!last || JSON.stringify(view)!==JSON.stringify(last)){
      const el=document.getElementById("resultsList");
      el.style.opacity="0";
      setTimeout(()=>{
        render(view);
        last=view;
        requestAnimationFrame(()=>el.style.opacity="1");
      },250);
    }

  }catch(e){
    document.getElementById("resultsList").innerHTML=
      `<div class="error">${e.message}</div>`;
  }
}

tick();
setInterval(tick,REFRESH_MS);
</script>
</body>
</html>
