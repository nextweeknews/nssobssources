<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Season 10 Rankings</title>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: transparent;
      font-family: Inter, system-ui, sans-serif;
      display: flex; justify-content: center; align-items: center;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    .card {
      width: 1720px;
      height: 880px; /* Fixed */
      background: rgba(15, 23, 42, 1);
      border-radius: 24px;
      padding: 48px 50px; /* Will adjust dynamically */
      display: flex;
      flex-direction: column;
      color: #e9eef8;
      box-shadow: 0 32px 32px rgba(0,0,0,0.65);
      box-sizing: border-box;
    }

    .title {
      font-size: 56px;
      color: #c7d7ff;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .035em;
      margin-bottom: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .header-row,
    .entry {
      display: grid;
      grid-template-columns: 150px 1fr 200px 180px 180px;
      align-items: center;
    }

    .header-row {
      height: 60px;
      margin-bottom: 14px;
      background: rgba(148, 163, 184, 0.12);
      font-size: 24px;
      font-weight: 700;
      text-transform: uppercase;
      color: #9ca3c7;
      border-radius: 12px;
      text-align: center;
      flex-shrink: 0;
    }

    .header-row span:nth-child(2) {
      text-align: left;
      padding-left: 24px;
    }

    #resultsList {
      display: flex;
      flex-direction: column;
      gap: 8px; /* Will adjust dynamically */
      flex-shrink: 1; /* Allow row area to compress inside card */
      opacity: 1;
      transition: opacity .3s ease, gap .3s ease;
      overflow: hidden; /* Prevent visual overflow */
    }

    .entry {
      height: 68px; /* Keep constant */
      background: rgba(255,255,255,0.07);
      border-radius: 14px;
      font-size: 32px;
      font-weight: 600;
      color: #fff;
      align-items: center;
      transition: background .3s ease, box-shadow .3s ease;
    }

    .place {
      font-size: 34px;
      font-weight: 900;
      text-align: center;
      color: #c7d7ff;
    }

    .player-name {
      font-size: 28px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding-left: 36px;
      padding-right: 36px;
    }

    .elo-value,
    .stat-value {
      font-size: 30px;
      font-weight: 800;
      text-align: center;
    }

    .gold   { color: #ffd700; }
    .silver { color: #c0c0c0; }
    .bronze { color: #cd7f32; }

    /* Column borders */
    .entry > span {
      border-right: 2px solid rgba(255,255,255,0.14);
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .entry > span:nth-child(2) { justify-content: flex-start; }
    .entry > span:last-child { border-right: none; }

    /* Highlight */
    .entry.highlight-gold {
      background: rgba(255, 215, 0, 0.28);
      box-shadow: 0 0 18px rgba(255, 215, 0, 0.3);
    }
    .entry.highlight-silver {
      background: rgba(192, 192, 192, 0.28);
      box-shadow: 0 0 18px rgba(192, 192, 192, 0.3);
    }
    .entry.highlight-bronze {
      background: rgba(205, 127, 50, 0.28);
      box-shadow: 0 0 18px rgba(205, 127, 50, 0.3);
    }
    .entry.highlight-default {
      background: rgba(52, 211, 153, 0.30);
      box-shadow: 0 0 18px rgba(16, 185, 129, 0.3);
    }

    .loading, .error {
      font-size: 36px;
      width: 100%;
      text-align: center;
    }
  </style>
</head>

<body>
<div class="card" id="card">
  <div class="title">Season 10 Rankings</div>

  <div class="header-row">
    <span>Rank</span>
    <span>Player</span>
    <span>Elo</span>
    <span>Wins</span>
    <span>Win Rate</span>
  </div>

  <div id="resultsList">
    <div class="loading">Loading…</div>
  </div>
</div>

<script>
const LB_URL = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const CLIENT_ID = "DISCORD|1069003073311211601";
const REFRESH_MS = 15000;

const cardEl = document.getElementById("card");
const resultsListEl = document.getElementById("resultsList");
const PLAYER_ID = new URLSearchParams(location.search).get("player_id");

const MAX_ROWS = 16;
const SLICE_ROWS = 15;
const ROW_HEIGHT = 68;
const HEADER_HEIGHT = 60 + 14;
const TITLE_HEIGHT = 56 + 24;
const CARD_HEIGHT = 880;
const BASE_PADDING = 48 + 50;

let lastRenderedState = null;

function adjustSpacing(rowCount) {
  if (!rowCount) return;
  const contentHeight = (ROW_HEIGHT * rowCount);

  // available = card height - fixed elements
  const remainingSpace = CARD_HEIGHT - TITLE_HEIGHT - HEADER_HEIGHT - contentHeight;

  // divide leftover space: top+bottom padding + gaps
  const gapCount = rowCount - 1;
  const idealGap = Math.max(8, (remainingSpace * 0.25) / gapCount);
  const newPadding = (remainingSpace - (idealGap * gapCount)) / 2;

  resultsListEl.style.gap = `${idealGap}px`;
  cardEl.style.paddingTop = `${48 + newPadding}px`;
  cardEl.style.paddingBottom = `${50 + newPadding}px`;
}

function render(list) {
  resultsListEl.innerHTML = "";
  list.forEach(p => {
    const row = document.createElement("div");
    row.className = "entry";

    const c = p.rank === 1 ? "gold" :
              p.rank === 2 ? "silver" :
              p.rank === 3 ? "bronze" : "";

    if (String(p.id) === String(PLAYER_ID)) {
      row.classList.add(
        p.rank === 1 ? "highlight-gold" :
        p.rank === 2 ? "highlight-silver" :
        p.rank === 3 ? "highlight-bronze" :
        "highlight-default"
      );
    }

    row.innerHTML = `
      <span class="place ${c}">${p.rank}</span>
      <span class="player-name">${p.name}</span>
      <span class="elo-value">${p.elo}</span>
      <span class="stat-value">${p.wins}</span>
      <span class="stat-value">${p.winRate != null ? p.winRate + "%" : "—"}</span>
    `;

    resultsListEl.appendChild(row);
  });

  adjustSpacing(list.length);
}

function parse(data) {
  return data.map((e, i) => {
    const id = e.team?.[0];
    const rp = e.resolved || {};
    const wins = e.count_placement_1 ?? 0;
    const matches = e.matches ?? 0;
    return {
      rank: i + 1,
      id,
      name: rp.display_name || rp.username || `Player ${id}`,
      elo: Math.round(e.elo ?? 0),
      wins,
      winRate: matches > 0 ? Math.round((wins / matches) * 100) : null
    };
  });
}

function sliceForPlayer(list) {
  const i = list.findIndex(p => String(p.id) === PLAYER_ID);
  if (i < 0) return list.slice(0, MAX_ROWS);

  if (list[i].rank <= MAX_ROWS) return list.slice(0, MAX_ROWS);

  const start = Math.min(
    Math.max(i - Math.floor(SLICE_ROWS/2), 0),
    list.length - SLICE_ROWS
  );
  return list.slice(start, start + SLICE_ROWS);
}

async function tick() {
  try {
    const r = await fetch(LB_URL,{
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        leaderboard:"season_10",
        rating_type:"player_global_all",
        client_id:CLIENT_ID
      })
    });
    const j = await r.json();
    const players = j.resolved?.players || {};
    const sorted = [...j.leaderboard].sort((a,b)=> (b.elo??0)-(a.elo??0));

    sorted.forEach(x => x.resolved = players[x.team?.[0]]);
    const list = parse(sorted);
    const view = sliceForPlayer(list);

    if (!lastRenderedState || JSON.stringify(view) !== JSON.stringify(lastRenderedState)) {
      resultsListEl.style.opacity = "0";
      setTimeout(() => {
        render(view);
        lastRenderedState = view;
        requestAnimationFrame(()=>resultsListEl.style.opacity = "1");
      }, 300);
    }
  } catch(e) {
    resultsListEl.innerHTML = `<div class="error">${e.message}</div>`;
  }
}

tick();
setInterval(tick, REFRESH_MS);
</script>
</body>
</html>
