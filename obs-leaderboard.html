<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leaderboard Overlay</title>
<style>
html, body {
  height:100%;
  margin:0;
  background: transparent;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow: hidden;
  display:flex;
  justify-content:center;
  align-items:center;
}

.card {
  width:420px;
  background: rgba(28,28,28,0.85);
  border-radius:12px;
  padding:10px 0;
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  color: #e9eef8;
  transition: height 0.5s ease;
}

.leaderboard-title {
  font-size:28px;
  color:#bcd4ff;
  font-weight:600;
  margin-bottom:10px;
}

#leaderboardList {
  width: 100%;
  position: relative;
}

.entry {
  width: calc(100% - 24px);
  display:flex;
  justify-content:space-between;
  padding:6px 12px;
  font-size:22px;
  font-weight:600;
  color:#ffffff;
  align-items:center;
  border-radius:6px;
  box-sizing: border-box;
  transition: background 0.3s, transform 0.3s, color 0.3s;
}

.entry span.rank { width:30px; text-align:right; color:#bcd4ff; }
.entry span.name { flex:1; text-align:left; padding-left:8px; }
.entry span.elo { width:60px; text-align:center; padding-left:8px; }

.entry.updated {
  animation: highlightChange 0.8s ease;
}

@keyframes highlightChange {
  0%   { background-color: rgba(255,255,255,0.4); transform: scale(1.02); }
  50%  { background-color: rgba(255,255,255,0.15); transform: scale(1.01); }
  100% { background-color: rgba(28,28,28,0.85); transform: scale(1); }
}

.entry.highlight {
  background: rgba(255,255,255,0.15);
}

.loading, .error {
  font-size:16px;
  color:#aab6d9;
}
</style>
</head>
<body>
<div class="card" id="cardRoot">
  <div class="leaderboard-title">Season 10</div>
  <div id="leaderboardList"></div>
</div>

<script>
const WORKER_URL = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const REFRESH_MS = 15000; // 15 seconds auto-refresh
const ROW_HEIGHT = 33;

const leaderboardEl = document.getElementById("leaderboardList");
const cardRoot = document.getElementById("cardRoot");
let lastLeaderboardState = [];

function getPlayerId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("player_id") || null;
}

function setLoading() {
  leaderboardEl.innerHTML = '<div class="loading">Loading leaderboard…</div>';
}

function setError(msg) {
  leaderboardEl.innerHTML = `<div class="error">Error: ${msg}</div>`;
  console.error(msg);
}

function displayLeaderboard(entries, resolvedPlayers) {
  const highlightPlayerId = getPlayerId();

  // Transform data
  const newState = entries.map((player, index) => {
    const playerId = player.team[0];
    const displayName = resolvedPlayers?.[playerId]?.display_name || "Unknown";
    return { rank: index + 1, id: playerId, name: displayName, elo: player.elo ?? "—" };
  });

  // Animate card height
  cardRoot.style.height = `${newState.length * ROW_HEIGHT + 40}px`;

  // Map existing entries
  const existingMap = {};
  Array.from(leaderboardEl.children).forEach(div => {
    existingMap[div.dataset.playerId] = div;
    div.dataset.marked = "false"; // mark for removal
  });

  // Add or update
  newState.forEach((player, index) => {
    let div = existingMap[player.id];
    if (!div) {
      // New entry
      div = document.createElement("div");
      div.className = "entry updated";
      div.dataset.playerId = player.id;
      div.innerHTML = `
        <span class="rank">${player.rank}</span>
        <span class="name">${player.name}</span>
        <span class="elo">${player.elo}</span>
      `;
      if (highlightPlayerId === player.id) div.classList.add("highlight");
      if (leaderboardEl.children[index]) {
        leaderboardEl.insertBefore(div, leaderboardEl.children[index]);
      } else {
        leaderboardEl.appendChild(div);
      }
      setTimeout(() => div.classList.remove("updated"), 800);
    } else {
      // Existing entry
      const nameEl = div.querySelector(".name");
      const eloEl = div.querySelector(".elo");
      let updated = false;

      if (nameEl && nameEl.textContent !== player.name) {
        nameEl.textContent = player.name;
        updated = true;
      }
      if (eloEl && eloEl.textContent !== player.elo) {
        eloEl.textContent = player.elo;
        updated = true;
      }

      // Highlight
      if (highlightPlayerId === player.id) div.classList.add("highlight");
      else div.classList.remove("highlight");

      if (updated) {
        div.classList.add("updated");
        setTimeout(() => div.classList.remove("updated"), 800);
      }

      // Move to correct position
      if (leaderboardEl.children[index] !== div) {
        leaderboardEl.insertBefore(div,
