<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard Overlay</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: transparent;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card {
      width: 420px;
      height: auto;
      background: rgba(28,28,28,0.85);
      border-radius: 12px;
      padding: 10px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      color: #e9eef8;
    }

    .leaderboard-title {
      font-size: 28px;
      color: #bcd4ff;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .entry {
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 6px 12px;
      font-size: 22px;
      font-weight: 600;
      color: #ffffff;
      align-items: center;
      border-radius: 6px;
      box-sizing: border-box;
      transition: background 0.3s;
    }

    .entry span.rank {
      width: 30px;
      text-align: right;
      padding-right: 16px;
      color: #bcd4ff;
    }

    .entry span.name {
      width: 280px;
      text-align: left;
      padding-left: 20px
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .entry span.elo {
      width: 60px;
      text-align: center;
      padding-left: 8px;
      flex-shrink: 0;
    }

    .entry.highlight {
      background: rgba(255, 255, 255, 0.15);
    }

    .loading, .error {
      font-size: 16px;
      color: #aab6d9;
    }
  </style>
</head>
<body>
  <div class="card" id="cardRoot">
    <div class="leaderboard-title">Season 10</div>
    <div id="leaderboardList"></div>
  </div>

  <script>
    const WORKER_URL = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
    const REFRESH_MS = 15000;
    const leaderboardEl = document.getElementById("leaderboardList");

    let lastState = [];

    function getPlayerId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("player_id") || null;
    }

    function setLoading() {
      leaderboardEl.innerHTML = '<div class="loading">Loading leaderboard…</div>';
    }

    function setError(msg) {
      leaderboardEl.innerHTML = `<div class="error">Error: ${msg}</div>`;
      console.error(msg);
    }

    function displayLeaderboard(entries, resolvedPlayers) {
      const highlightPlayerId = getPlayerId();
      const newState = entries.map((player, index) => {
        const playerId = player.team[0];
        const displayName = resolvedPlayers?.[playerId]?.display_name || "Unknown";
        return {
          rank: index + 1,
          id: playerId,
          name: displayName,
          elo: player.elo ?? "—"
        };
      });

      // Map current DOM rows by playerId
      const existingRows = {};
      Array.from(leaderboardEl.children).forEach(row => {
        const id = row.dataset.playerId;
        if (id) existingRows[id] = row;
      });

      newState.forEach((player, index) => {
        let row = existingRows[player.id];

        if (row) {
          // Update only if something changed
          if (row.querySelector(".name").textContent !== player.name) {
            row.querySelector(".name").textContent = player.name;
          }
          if (row.querySelector(".elo").textContent !== player.elo) {
            row.querySelector(".elo").textContent = player.elo;
          }
          // Update highlight
          if (highlightPlayerId === player.id) row.classList.add("highlight");
          else row.classList.remove("highlight");

          // Reorder rows if needed
          if (leaderboardEl.children[index] !== row) {
            leaderboardEl.insertBefore(row, leaderboardEl.children[index]);
          }
        } else {
          // New row
          row = document.createElement("div");
          row.className = "entry";
          if (highlightPlayerId === player.id) row.classList.add("highlight");
          row.dataset.playerId = player.id;

          row.innerHTML = `
            <span class="rank">${player.rank}</span>
            <span class="name">${player.name}</span>
            <span class="elo">${player.elo}</span>
          `;

          if (leaderboardEl.children[index]) {
            leaderboardEl.insertBefore(row, leaderboardEl.children[index]);
          } else {
            leaderboardEl.appendChild(row);
          }
        }
      });

      // Remove old rows that are no longer present
      Array.from(leaderboardEl.children).forEach(row => {
        if (!newState.find(p => p.id === row.dataset.playerId)) {
          leaderboardEl.removeChild(row);
        }
      });

      lastState = newState;
    }

    async function fetchLeaderboard() {
      setLoading();
      try {
        const resp = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            leaderboard: "season_10",
            rating_type: "player_global_all",
            client_id: "DISCORD|1069003073311211601",
            limit: 16
          })
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${text}`);
        }

        const data = await resp.json();
        const entries = data.leaderboard || [];
        const resolvedPlayers = data.resolved?.players || {};
        displayLeaderboard(entries, resolvedPlayers);

      } catch (err) {
        setError(err.message);
      }
    }

    let intervalHandle = null;
    function startAutoRefresh() {
      fetchLeaderboard();
      if (intervalHandle) clearInterval(intervalHandle);
      intervalHandle = setInterval(fetchLeaderboard, REFRESH_MS);
    }

    window.addEventListener("load", startAutoRefresh);
  </script>
</body>
</html>
