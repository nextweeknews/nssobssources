<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Match Lobby</title>

<style>
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: transparent;
    font-family: Inter, system-ui, sans-serif;
    display: flex; justify-content: center; align-items: center;
    -webkit-font-smoothing: antialiased;
    overflow: hidden;
  }

  .card {
    width: 1720px;
    background: rgba(15, 23, 42, 1);
    border-radius: 24px;
    padding: 48px 50px;
    display: flex;
    flex-direction: column;
    transition: height 0.4s ease;
    align-items: stretch;
    color: #e9eef8;
    box-shadow: 0 32px 32px rgba(0,0,0,0.65);
    box-sizing: border-box;
  }

  .title {
    font-size: 56px;
    color: #c7d7ff;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: .035em;
    margin-bottom: 24px;
    text-align: center;
  }

  .header-row,
  .entry {
    display: grid;
    grid-template-columns: 150px 1fr 200px 170px 200px;
    align-items: center;
  }

  /* HEADER formatting */
  .header-row {
    height: 60px;
    margin-bottom: 14px;
    background: rgba(148, 163, 184, 0.12);
    font-size: 24px;
    font-weight: 700;
    text-transform: uppercase;
    color: #9ca3c7;
    border-radius: 12px;
  }

  /* HEADER alignment — fixed */
  .header-row .col {
    border-right: none !important;
    justify-content: center;
    text-align: center;      /* True centering fix */
    padding-left: 0;
  }

  .header-row .col.col-name {
    justify-content: flex-start;
    text-align: left;        /* Player left aligned */
    padding-left: 24px;
  }

  /* ROW formatting */
  .entry .col {
    height: 45px;
    display: flex;
    align-items: center;
    padding: 0 12px;
    font-size: 42px;
    font-weight: 600;
    color: #fff;
    justify-content: center;
    border-right: 2px solid rgba(255,255,255,0.14);
  }
  .entry .col:last-child {
    border-right: none;
  }

  .entry .col-rank {
    font-weight: 900;
    width: 100%;
    text-align: center;
  }

  .entry .col-name {
    font-size: 36px;
    font-weight: 600;
    text-align: left;
    padding-left: 24px;
  }

  .entry .col-elo {
    font-weight: 900;
    text-align: center;
    line-height: 1;
  }

  .entry .col-wins {
    font-size: 36px;
    color: #98fb98;
    text-align: center;
  }

  .entry .col-winrate {
    font-size: 36px;
    color: #d3d3d3;
    text-align: center;

  }

  #resultsList {
    display: flex;
    flex-direction: column;
    gap: 10px;
    opacity: 1;
    transition: opacity .3s ease;
  }

  .entry {
    height: 90px;
    background: rgba(255,255,255,0.07);
    border-radius: 14px;
    transition: background .3s ease, box-shadow .3s ease;
  }

  /* Highlight current user row */
  .entry.highlight-default {
    background: rgba(52,211,153,0.30);
    box-shadow: 0 0 18px rgba(16,185,129,0.3);
  }

  /* Medal coloring */
  .col-rank.rank-1 { color: #ffd700; }
  .col-rank.rank-2 { color: #c0c0c0; }
  .col-rank.rank-3 { color: #cd7f32; }

  .loading, .error {
    font-size: 36px;
    text-align: center;
    width: 100%;
  }
</style>
</head>

<body>
<div class="card" id="card">
  <div class="title">Match Lobby</div>

  <div class="header-row">
    <span class="col col-rank">Rank</span>
    <span class="col col-name">Player</span>
    <span class="col col-elo">Elo</span>
    <span class="col col-wins">Wins</span>
    <span class="col col-winrate">Win Rate</span>
  </div>

  <div id="resultsList"><div class="loading">Waiting for players…</div></div>
</div>

<script>
const API_URL = "https://blue-dust-07fa.nextweekmedia.workers.dev/lobby";
const LB_URL  = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const CLIENT_ID = "DISCORD|1069003073311211601";

const resultsListEl = document.getElementById("resultsList");
const cardEl = document.getElementById("card");

let lastHash = "";
let lastRefreshVersion = 0;

function resizeCard(count) {
  const h = 56 + 24 + 60 + 14 + 48 + 50 + (90 * count) + (10 * (count - 1));
  cardEl.style.height = `${h}px`;
}

function fadeOut(cb){resultsListEl.style.opacity=0;setTimeout(cb,400);}
function fadeIn(){resultsListEl.style.opacity=1;}
function formatWinRate(w,m){return !m?"—":((w/m)*100).toFixed(1)+"%";}

function display(rows, tracked){
  resultsListEl.innerHTML="";
  rows.forEach(r=>{
    const row=document.createElement("div");
    row.className="entry";
    if(String(r.id)===String(tracked)) row.classList.add("highlight-default");
    row.innerHTML=`
      <span class="col col-rank rank-${r.rank}">${r.rank}</span>
      <span class="col col-name">${r.name}</span>
      <span class="col col-elo">${Math.round(r.elo)}</span>
      <span class="col col-wins">${r.wins}</span>
      <span class="col col-winrate">${formatWinRate(r.wins,r.matches)}</span>
    `;
    resultsListEl.appendChild(row);
  });
  resizeCard(rows.length);
}

async function updateLobby(){
  try {
    const lobby = await (await fetch(API_URL)).json();
    const lb = await (await fetch(LB_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        leaderboard:"season_10",
        rating_type:"player_global_all",
        client_id:CLIENT_ID
      })
    })).json();

    const res = lb.resolved?.players || {};
    const leaderboard = lb.leaderboard || [];

    if(!Array.isArray(lobby.players)||lobby.players.length<2){
      resultsListEl.innerHTML = `<div class='loading'>Add 2+ players</div>`;
      return;
    }

    const sorted=[...leaderboard].sort((a,b)=>(b.elo??0)-(a.elo??0));
    const rankMap={}; sorted.forEach((e,i)=>rankMap[e.team?.[0]]=i+1);

    const rows = lobby.players.map(id=>{
      const e=leaderboard.find(x=>String(x.team?.[0])===String(id))||{};
      return{
        id,
        rank:rankMap[id]??"—",
        name:res[id]?.display_name||res[id]?.username||`Player ${id}`,
        elo:e.elo??0,
        wins:e.count_placement_1??0,
        matches:e.matches??0
      };
    }).sort((a,b)=>(a.rank??99999)-(b.rank??99999));

    const hash = rows.map(r => `${r.id}:${r.rank}:${r.elo}:${r.wins}:${r.matches}`).join("|");

    if(hash!==lastHash){
      lastHash = hash;
      fadeOut(()=>{display(rows,lobby.tracked);fadeIn();});
    }

    lastRefreshVersion = lobby.refresh_version;
  } catch(err){
    resultsListEl.innerHTML = `<div class='error'>API Error</div>`;
  }
}

updateLobby();

setInterval(async ()=>{
  const lobby = await (await fetch(API_URL)).json();
  if(lobby.refresh_version !== lastRefreshVersion){
    await updateLobby();
  }
}, 1500);
</script>
</body>
</html>
