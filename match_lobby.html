<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Match Lobby</title>

<style>
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: transparent;
    font-family: Inter, system-ui, sans-serif;
    display: flex; justify-content: center; align-items: center;
    -webkit-font-smoothing: antialiased;
    overflow: hidden;
  }

  .card {
    width: 1720px;
    background: rgba(15, 23, 42, 1);
    border-radius: 24px;
    padding: 48px 50px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    transition: height 0.4s ease;
    color: #e9eef8;
    box-shadow: 0 32px 32px rgba(0,0,0,0.65);
    box-sizing: border-box;
  }

  .title {
    font-size: 56px;
    color: #c7d7ff;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: .035em;
    margin-bottom: 24px;
    text-align: center;
  }

  .header-row,
  .entry {
    display: grid;
    grid-template-columns: 150px 1fr 200px 170px 200px;
    align-items: center;
  }

  .header-row {
    height: 60px;
    margin-bottom: 14px;
    background: rgba(148, 163, 184, 0.12);
    font-size: 24px;
    font-weight: 700;
    text-transform: uppercase;
    color: #9ca3c7;
    border-radius: 12px;
    text-align: center;
  }

  #resultsList {
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: opacity .3s ease;
  }

  .entry {
    height: 90px;
    background: rgba(255,255,255,0.07);
    border-radius: 14px;
    font-size: 42px;
    font-weight: 600;
    color: #fff;
    align-items: center;
    transition: background .3s ease, box-shadow .3s ease;
  }

  .highlight-default {
    background: rgba(52, 211, 153, 0.30);
    box-shadow: 0 0 18px rgba(16, 185, 129, 0.3);
  }

  .entry > span {
    border-right: 2px solid rgba(255,255,255,0.14);
    height: 45px;
    right: -1px;
    position: relative;
    vertical-align: middle;
  }
  .entry > span:last-child { border-right: none; }

  .loading, .error {
    font-size: 36px;
    width: 100%;
    text-align: center;
  }

  /* Center-align numeric/stat columns */
  .col-rank,
  .col-elo,
  .col-wins,
  .col-winrate {
    text-align: center;
  }

  /* Rank column */
  .col-rank {
    font-weight: 900;
    color: #c7d7ff;
  }

  /* Player column */
  .col-player {
    font-size: 36px;
    font-weight: 600;
    padding-left: 24px;
    text-align: left;
    text-transform: none;
  }

  /* Elo column */
  .col-elo {
    font-weight: 900;
  }

  /* Wins column */
  .col-wins {
    color: #98fb98;
    font-weight: 600;
  }

  /* Win Rate column */
  .col-winrate {
    color: #d3d3d3;
    font-weight: 600;
  }

  /* Header center for numeric/stat columns */
  .header-row span:nth-child(1),
  .header-row span:nth-child(3),
  .header-row span:nth-child(4),
  .header-row span:nth-child(5) {
    text-align: center;
  }

  /* Player column left w/ padding */
  .col-player {
    text-align: left;
    padding-left: 24px;
  }
  .header-row span:nth-child(2) {
    text-align: left;
    padding-left: 24px;
  }

  /* Rank medals */
  .col-rank.rank-1 {
    color: #ffd700; /* Gold */
  }
  .col-rank.rank-2 {
    color: #c0c0c0; /* Silver */
  }
  .col-rank.rank-3 {
    color: #cd7f32; /* Bronze */
  }
</style>
</head>

<body>
<div class="card" id="card">
  <div class="title">Match Lobby</div>

  <div class="header-row">
    <span>Rank</span>
    <span>Player</span>
    <span>Elo</span>
    <span>Wins</span>
    <span>Win Rate</span>
  </div>

  <div id="resultsList"><div class="loading">Waiting for players…</div></div>
</div>

<script>
const API_URL = "https://blue-dust-07fa.nextweekmedia.workers.dev/lobby";
const LB_URL = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const CLIENT_ID = "DISCORD|1069003073311211601";
const REFRESH_MS = 10000;
const resultsListEl = document.getElementById("resultsList");
const cardEl = document.getElementById("card");
let lastHash = "";

function resizeCard(count) {
  const h = 56 + 24 + 60 + 14 + 48 + 50 + (90 * count) + (10 * (count - 1));
  cardEl.style.height = `${h}px`;
}

function hashState(rows) {
  return rows.map(r => `${r.id}:${r.rank}:${r.elo}:${r.wins}:${r.matches}`).join("|");
}

function formatWinRate(wins, matches) {
  if (!matches) return "—";
  return `${((wins / matches) * 100).toFixed(1)}%`;
}

function display(rows, tracked) {
  resultsListEl.innerHTML = "";
  rows.forEach(r => {
    const div = document.createElement("div");
    div.className = "entry";
    if (tracked && String(r.id) === String(tracked)) {
      div.classList.add("highlight-default");
    }

    div.innerHTML = `
      <span class="col-rank rank-${r.rank}">${r.rank}</span>
      <span class="col-player">${r.name}</span>
      <span class="col-elo">${Math.round(r.elo)}</span>
      <span class="col-wins">${r.wins}</span>
      <span class="col-winrate">${formatWinRate(r.wins, r.matches)}</span>`;

    resultsListEl.appendChild(div);
  });
  resizeCard(rows.length);
}

async function fetchData() {
  try {
    const lobby = await (await fetch(API_URL)).json();
    if (!Array.isArray(lobby.players) || lobby.players.length < 2)
      return resultsListEl.innerHTML = `<div class='loading'>Add 2+ players</div>`;

    const lb = await (await fetch(LB_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        leaderboard: "season_10",
        rating_type: "player_global_all",
        client_id: CLIENT_ID
      })
    })).json();

    const leaderboard = lb.leaderboard || [];
    const resolved = lb.resolved?.players || {};

    const sortedByElo = [...leaderboard].sort((a,b)=>(b.elo ?? 0)-(a.elo ?? 0));
    const rankMap = {};
    sortedByElo.forEach((e,i)=> rankMap[e.team?.[0]] = i+1 );

    const rows = lobby.players.map(id => {
      const entry = leaderboard.find(e => String(e.team?.[0]) === String(id)) || {};
      return {
        id,
        name: resolved[id]?.display_name || resolved[id]?.username || `Player ${id}`,
        elo: entry.elo ?? 0,
        wins: entry.count_placement_1 ?? 0,
        matches: entry.matches ?? 0,
        rank: rankMap[id] ?? "—"
      };
    }).sort((a,b)=>(a.rank ?? 99999)-(b.rank ?? 99999));

    const hash = hashState(rows);
    if (hash !== lastHash) {
      lastHash = hash;
      resultsListEl.style.opacity = 0;
      setTimeout(()=>{
        display(rows, lobby.tracked);
        resultsListEl.style.opacity = 1;
      },300);
    }
  } catch {
    resultsListEl.innerHTML = `<div class='error'>API Error</div>`;
  }
}

fetchData();
setInterval(fetchData, REFRESH_MS);
</script>
</body>
</html>
