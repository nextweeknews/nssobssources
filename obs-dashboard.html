<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ELO • RANK • WINS • TIER</title>

<style>
html, body {
  height:100%;
  margin:0;
  background:transparent;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
}

:root { --card-bg:rgba(28,28,28,0.95); }

.card {
  width:750px;
  height:245px;
  background:var(--card-bg);
  border-radius:28px;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px 22px;
  color:#e9eef8;
}

/* Tier Row */
#tierRow {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  margin-bottom:6px;
}

#tierLabel {
  font-size:26px;
  font-weight:800;
  color:#bcd4ff;
  text-transform:uppercase;
}

/* Tier Badge */
#tierContainer {
  padding:6px 20px;
  border-radius:18px;
  background:rgba(255,255,255,0.08);
}

#tierText {
  font-size:32px;
  font-weight:900;
}

/* Stats Row */
.row {
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:4px;
}

.section {
  display:flex;
  flex-direction:column;
  align-items:center;
  position:relative;
}

.section.rank { width:30%; }
.section.elo { width:40%; }
.section.wins { width:30%; }

.label {
  font-size:26px;
  font-weight:800;
  color:#bcd4ff;
  margin-bottom:6px;
  text-transform:uppercase;
}

.metric {
  font-size:86px;
  font-weight:800;
  line-height:1;
  white-space:nowrap;
}

/* Improved Divider Position */
.section:after {
  content:"";
  position:absolute;
  right:-10px;
  top:50%;
  transform:translateY(-55%);
  width:3px;
  height:72px;
  background:rgba(255,255,255,0.12);
  border-radius:2px;
}

.section:last-child:after { display:none; }

/* Deltas */
.delta {
  font-size:28px;
  font-weight:700;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.4s ease;
  margin-top:4px;
}

.delta-positive { color:#4ade80; }
.delta-negative { color:#f87171; }
.delta-arrow { margin-right:4px; }
</style>
</head>

<body>
<div class="card">

  <!-- Tier -->
  <div id="tierRow">
    <div id="tierLabel">Tier</div>
    <div id="tierContainer"><span id="tierText">—</span></div>
  </div>

  <div class="row">

    <div class="section rank">
      <div class="label">Rank</div>
      <span id="rankNumber" class="metric">—</span>
      <span id="rankDelta" class="delta"><span class="delta-arrow"></span><span class="delta-number"></span></span>
    </div>

    <div class="section elo">
      <div class="label">Elo</div>
      <span id="eloNumber" class="metric">—</span>
      <span id="eloDelta" class="delta"><span class="delta-arrow"></span><span class="delta-number"></span></span>
    </div>

    <div class="section wins">
      <div class="label">Wins</div>
      <span id="winsNumber" class="metric">—</span>
      <span id="winsDelta" class="delta"><span class="delta-arrow"></span><span class="delta-number"></span></span>
    </div>

  </div>
</div>

<script>
const WORKER_URL="https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const REFRESH_MS=15000;

const eloEl=document.getElementById("eloNumber");
const winsEl=document.getElementById("winsNumber");
const rankEl=document.getElementById("rankNumber");
const tierTextEl=document.getElementById("tierText");
const tierContainer=document.getElementById("tierContainer");

const eloDeltaEl=document.getElementById("eloDelta");
const winsDeltaEl=document.getElementById("winsDelta");
const rankDeltaEl=document.getElementById("rankDelta");

let lastElo=null,lastRank=null,lastWins=null;

function getPlayerId(){
  const pid=new URLSearchParams(location.search).get("player_id");
  return /^\d{19}$/.test(pid)?pid:"702730732220579950";
}

function animateDelta(el,oldVal,newVal,reverse=false){
  const diff=newVal-oldVal;
  if(!oldVal || diff===0) return;
  const arrow=el.querySelector(".delta-arrow");
  const number=el.querySelector(".delta-number");
  arrow.textContent=diff>0?(reverse?"▼":"▲"):(reverse?"▲":"▼");
  number.textContent=Math.abs(diff);
  el.classList.remove("delta-positive","delta-negative");
  el.classList.add((diff>0 ^ reverse)?"delta-positive":"delta-negative");
  el.style.opacity="1";
  setTimeout(()=>el.style.opacity="0",6500);
}

function formatTierName(name){
  return name?.replace(/^Season\s+\d+\s+/i,"") ?? "";
}

function getTier(elo,rank,data){
  const cfg=data.resolved?.leaderboards?.["Season_10"];
  if(!cfg) return null;
  if(rank===1 && cfg.player_global_all_rank_tiers?.length)
    return cfg.player_global_all_rank_tiers[0];
  let best=null;
  for(const t of cfg.player_global_all_tiers) if(elo>=t.required_elo) best=t;
  return best;
}

async function fetchData(){
  const pid=getPlayerId();
  const resp=await fetch(WORKER_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      leaderboard:"season_10",
      rating_type:"player_global_all",
      client_id:"DISCORD|1069003073311211601"
    })
  });

  if(!resp.ok) return;
  const data=await resp.json();
  const sorted=[...(data.leaderboard ?? [])].sort((a,b)=> (b.elo??0)-(a.elo??0));
  const idx=sorted.findIndex(e=>e.team?.[0]===pid);
  if(idx<0) return;

  const p=sorted[idx];
  const elo=p.elo ?? 0;
  const wins=p.count_placement_1 ?? 0;
  const rank=idx+1;

  if(lastElo!==null && elo!==lastElo) animateDelta(eloDeltaEl,lastElo,elo);
  if(lastRank!==null && rank!==lastRank) animateDelta(rankDeltaEl,lastRank,rank,true);
  if(lastWins!==null && wins!==lastWins) animateDelta(winsDeltaEl,lastWins,wins);

  eloEl.textContent=elo;
  winsEl.textContent=wins;
  rankEl.textContent=rank;

  lastElo=elo; lastRank=rank; lastWins=wins;

  const tier=getTier(elo,rank,data);
  if(tier){
    const c=tier.color;
    const r=parseInt(c.slice(1,3),16),g=parseInt(c.slice(3,5),16),b=parseInt(c.slice(5,7),16);
    tierTextEl.textContent=formatTierName(tier.name);
    tierTextEl.style.textShadow=`0 0 10px ${c}, 0 0 18px ${c}`;
    tierContainer.style.background=`rgba(${r},${g},${b},0.22)`;
  } else {
    tierTextEl.textContent="UNRANKED";
    tierTextEl.style.textShadow="none";
    tierContainer.style.background="rgba(255,255,255,0.08)";
  }
}

fetchData();
setInterval(fetchData,REFRESH_MS);
</script>

</body>
</html>
