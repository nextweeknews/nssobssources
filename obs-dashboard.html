<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Elo • Rank • Tier</title>

<style>
html, body {
  height:100%;
  margin:0;
  background: transparent;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
}

:root {
  --card-bg: rgba(28,28,28,0.95);
}

.card {
  width:700px;
  height:230px;
  background: var(--card-bg);
  border-radius:28px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:center;
  padding:16px 22px;
  text-align:center;
  color:#e9eef8;
}

/* Tier Inline Row */
#tierRow {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  margin-bottom:18px;
}

/* Tier Label */
#tierLabel {
  font-size:26px;
  font-weight:700;
  color:#bcd4ff;
}

/* Tier Badge */
#tierContainer {
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px 20px;
  border-radius:18px;
  background:rgba(255,255,255,0.08); /* overridden by JS */
  transition:background 0.4s ease;
}

#tierText {
  font-size:32px;
  font-weight:900;
  text-transform:uppercase;
  transition: color 0.4s ease, text-shadow 0.4s ease;
}

/* Rank + Elo */
.row {
  width:100%;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}

.rank-section { width:30%; }
.elo-section  { width:68%; }

.label {
  font-size:26px;
  font-weight:700;
  color:#bcd4ff;
  margin-bottom:4px;
}

.metric {
  font-size:110px;
  font-weight:800;
  line-height:1;
  white-space:nowrap;
}

.divider {
  width:2.5px;
  height:80px;
  background:rgba(255,255,255,0.10);
  border-radius:2px;
  margin:0 10px;
}

/* Deltas */
.delta {
  font-size:30px;
  font-weight:600;
  opacity:0;
  pointer-events:none;
  display:inline-flex;
  align-items:center;
  margin-top:3px;
  transition:opacity 0.4s ease, transform 0.4s ease;
}

.delta-positive { color:#4ade80; }
.delta-negative { color:#f87171; }
.delta-arrow { margin-right:4px; }
</style>
</head>

<body>
<div class="card">

  <!-- ⭐ Tier inline -->
  <div id="tierRow">
    <div id="tierLabel">Tier</div>
    <div id="tierContainer">
      <span id="tierText">—</span>
    </div>
  </div>

  <div class="row">
    <div class="section rank-section">
      <div class="label">Rank</div>
      <span id="rankNumber" class="metric">—</span>
      <span id="rankDelta" class="delta">
        <span class="delta-arrow"></span>
        <span class="delta-number"></span>
      </span>
    </div>

    <div class="divider"></div>

    <div class="section elo-section">
      <div class="label">Elo</div>
      <span id="eloNumber" class="metric">—</span>
      <span id="eloDelta" class="delta">
        <span class="delta-arrow"></span>
        <span class="delta-number"></span>
      </span>
    </div>
  </div>

</div>

<script>
const WORKER_URL = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const REFRESH_MS = 15000;

const eloEl = document.getElementById("eloNumber");
const rankEl = document.getElementById("rankNumber");
const tierTextEl = document.getElementById("tierText");
const tierContainer = document.getElementById("tierContainer");

const eloDeltaEl = document.getElementById("eloDelta");
const rankDeltaEl = document.getElementById("rankDelta");

const arrowElo = eloDeltaEl.querySelector(".delta-arrow");
const numberElo = eloDeltaEl.querySelector(".delta-number");
const arrowRank = rankDeltaEl.querySelector(".delta-arrow");
const numberRank = rankDeltaEl.querySelector(".delta-number");

let lastElo = null;
let lastRank = null;

function getPlayerId() {
  const pid = new URLSearchParams(location.search).get("player_id");
  return /^\d{19}$/.test(pid) ? pid : "702730732220579950";
}

function animateDelta(el, arrow, number, oldVal, newVal, reverse = false) {
  const diff = newVal - oldVal;
  if (diff === 0 || oldVal === null) return;
  arrow.textContent = diff > 0 ? (reverse ? "▼" : "▲") : (reverse ? "▲" : "▼");
  number.textContent = Math.abs(diff);

  el.classList.remove("delta-positive","delta-negative");
  const isPositive = !!(diff > 0 ^ reverse);
  el.classList.add(isPositive ? "delta-positive" : "delta-negative");

  el.style.opacity = "0";
  el.style.transform = "translateY(10px)";
  requestAnimationFrame(()=>{
    el.style.opacity = "1";
    el.style.transform = "translateY(0)";
  });
  setTimeout(()=>{ el.style.opacity="0"; },8000);
}

function formatTierName(name) {
  return name?.replace(/^Season\s+\d+\s+/i,"") ?? "";
}

function getPlayerTier(elo, rank, data) {
  const cfg = data.resolved?.leaderboards?.["Season_10"];
  if (!cfg) return null;
  const tiers = cfg.player_global_all_tiers ?? [];
  const rankTiers = cfg.player_global_all_rank_tiers ?? [];

  if (rank===1 && rankTiers.length>0) return rankTiers[0];

  let best=null;
  for (const t of tiers) if (elo>=t.required_elo) best=t;
  return best;
}

async function fetchData() {
  const pid = getPlayerId();
  const resp = await fetch(WORKER_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      leaderboard:"season_10",
      rating_type:"player_global_all",
      client_id:"DISCORD|1069003073311211601"
    })
  });
  if (!resp.ok) return;
  const data = await resp.json();

  const entries = data.leaderboard ?? [];
  if (!entries.length) return;

  const sorted=[...entries].sort((a,b)=>(b.elo??0)-(a.elo??0));
  const idx = sorted.findIndex(e=>e.team?.[0]===pid);
  if (idx<0) return;

  const p = sorted[idx];
  const elo = p.elo ?? 0;
  const rank = idx+1;

  if (lastElo!==null && elo!==lastElo)
    animateDelta(eloDeltaEl,arrowElo,numberElo,lastElo,elo);
  if (lastRank!==null && rank!==lastRank)
    animateDelta(rankDeltaEl,arrowRank,numberRank,lastRank,rank,true);

  eloEl.textContent = elo;
  rankEl.textContent = rank;
  lastElo = elo;
  lastRank = rank;

  const tier = getPlayerTier(elo,rank,data);
  if (tier) {
    const color = tier.color;
    const r = parseInt(color.slice(1,3),16);
    const g = parseInt(color.slice(3,5),16);
    const b = parseInt(color.slice(5,7),16);

    tierTextEl.textContent = formatTierName(tier.name);
    tierTextEl.style.color = color;
    tierTextEl.style.textShadow = `0 0 6px ${color}, 0 0 14px ${color}`;
    tierContainer.style.background = `rgba(${r}, ${g}, ${b}, 0.22)`;

  } else {
    tierTextEl.textContent = "Unranked";
    tierTextEl.style.color = "#bbb";
    tierTextEl.style.textShadow = "none";
    tierContainer.style.background = "rgba(255,255,255,0.08)";
  }
}

fetchData();
setInterval(fetchData, REFRESH_MS);
</script>

</body>
</html>

