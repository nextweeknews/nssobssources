<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Elo • Rank • Tier</title>

<style>
html, body {
  height:100%;
  margin:0;
  background: transparent;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
}

.card {
  width:600px;
  height:240px;
  background: rgba(28,28,28,0.95);
  border-radius:24px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  color:#e9eef8;
  padding:10px 20px;
}

/* Tier moved to top */
#tierContainer {
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:10px;
}

.tier-label {
  font-size:18px;
  font-weight:600;
  color:#bcd4ff;
}

#tierText {
  font-size:26px;
  font-weight:700;
  text-transform:uppercase;
}

.row {
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:6px;
}

/* Separator between Rank and Elo */
.divider {
  width:2px;
  height:80px;
  background:rgba(255,255,255,0.08);
  border-radius:2px;
}

.section {
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* Rank + Elo labels + values */
.label {
  font-size:26px;
  font-weight:600;
  color:#bcd4ff;
  margin-bottom:4px;
}

.metric {
  font-size:80px;
  font-weight:700;
  line-height:1;
  white-space:nowrap;
}

.delta {
  font-size:28px;
  font-weight:600;
  opacity:0;
  pointer-events:none;
  display:inline-flex;
  align-items:center;
  margin-top:4px;
  transition:opacity 0.4s ease, transform 0.4s ease;
}

.delta-positive { color:#4ade80; }
.delta-negative { color:#f87171; }
.delta-arrow { margin-right:4px; }
</style>
</head>

<body>
<div class="card">

  <!-- ⭐ Tier moved up here -->
  <div id="tierContainer">
    <span class="tier-label">Tier:</span>
    <span id="tierText">—</span>
  </div>

  <div class="row">
    <div class="section" style="width:45%">
      <div class="label">Rank</div>
      <span id="rankNumber" class="metric">—</span>
      <span id="rankDelta" class="delta">
        <span class="delta-arrow"></span>
        <span class="delta-number"></span>
      </span>
    </div>

    <div class="divider"></div>

    <div class="section" style="width:45%">
      <div class="label">ELO</div>
      <span id="eloNumber" class="metric">—</span>
      <span id="eloDelta" class="delta">
        <span class="delta-arrow"></span>
        <span class="delta-number"></span>
      </span>
    </div>
  </div>

</div>

<script>
const WORKER_URL = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_leaderboard";
const REFRESH_MS = 15000;

const eloEl = document.getElementById("eloNumber");
const rankEl = document.getElementById("rankNumber");
const tierTextEl = document.getElementById("tierText");

const eloDeltaEl = document.getElementById("eloDelta");
const rankDeltaEl = document.getElementById("rankDelta");

const arrowElo = eloDeltaEl.querySelector(".delta-arrow");
const numberElo = eloDeltaEl.querySelector(".delta-number");

const arrowRank = rankDeltaEl.querySelector(".delta-arrow");
const numberRank = rankDeltaEl.querySelector(".delta-number");

let lastElo = null;
let lastRank = null;

// Validate player_id 19 digits
function getPlayerId() {
  const pid = new URLSearchParams(location.search).get("player_id");
  return /^\d{19}$/.test(pid) ? pid : "702730732220579950";
}

// Delta animation
function animateDelta(el, arrow, number, oldVal, newVal, reverse = false) {
  const diff = newVal - oldVal;
  if (diff === 0 || oldVal === null) return;

  arrow.textContent = diff > 0 ? (reverse ? "▼" : "▲") : (reverse ? "▲" : "▼");
  number.textContent = Math.abs(diff);

  el.classList.remove("delta-positive", "delta-negative");
  const isPositive = !!(diff > 0 ^ reverse);
  el.classList.add(isPositive ? "delta-positive" : "delta-negative");

  el.style.opacity = "0";
  el.style.transform = "translateY(10px)";
  requestAnimationFrame(() => {
    el.style.opacity = "1";
    el.style.transform = "translateY(0)";
  });

  setTimeout(() => {
    el.style.opacity = "0";
  }, 8000);
}

// Trim "Season 10 "
function formatTierName(name) {
  if (!name) return "";
  return name.replace(/^Season\s+\d+\s+/i, "");
}

function getPlayerTier(elo, rank, data) {
  const seasonConfig = data.resolved?.leaderboards?.["Season_10"];
  if (!seasonConfig) return null;

  const tiers = seasonConfig.player_global_all_tiers || [];
  const rankTiers = seasonConfig.player_global_all_rank_tiers || [];

  if (rank === 1 && rankTiers.length > 0) {
    return { name: rankTiers[0].name, color: rankTiers[0].color };
  }

  let currentTier = null;
  for (const t of tiers) {
    if (elo >= t.required_elo) currentTier = t;
  }
  return currentTier;
}

async function fetchData() {
  const pid = getPlayerId();
  try {
    const resp = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        leaderboard: "season_10",
        rating_type: "player_global_all",
        client_id: "DISCORD|1069003073311211601"
      })
    });

    if (!resp.ok) return console.error("HTTP", resp.status);
    const data = await resp.json();

    const entries = data.leaderboard || [];
    if (!entries.length) return;

    const sorted = [...entries].sort((a,b)=> (b.elo ??0)-(a.elo ??0));
    const idx = sorted.findIndex(e=> e.team?.[0]===pid);
    if (idx<0) return;

    const player = sorted[idx];
    const elo = player.elo ?? 0;
    const rank = idx+1;

    if (lastElo!==null && elo!==lastElo)
      animateDelta(eloDeltaEl,arrowElo,numberElo,lastElo,elo);
    if (lastRank!==null && rank!==lastRank)
      animateDelta(rankDeltaEl,arrowRank,numberRank,lastRank,rank,true);

    eloEl.textContent = elo;
    rankEl.textContent = rank;
    lastElo = elo;
    lastRank = rank;

    const tier = getPlayerTier(elo, rank, data);
    if (tier) {
      tierTextEl.textContent = formatTierName(tier.name);
      tierTextEl.style.color = tier.color;
    } else {
      tierTextEl.textContent = "UNRANKED";
      tierTextEl.style.color = "#e9eef8";
    }

  } catch (err) { console.error("Fetch error:", err); }
}

fetchData();
setInterval(fetchData, REFRESH_MS);
</script>

</body>
</html>
