<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Previous Match Results</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: transparent;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card {
      width: 480px;
      background: rgba(28,28,28,0.85);
      border-radius: 12px;
      padding: 10px;
      color: #e9eef8;
      text-align: center;
    }

    .title {
      font-size: 28px;
      color: #bcd4ff;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .entry {
      display: flex;
      justify-content: space-between;
      padding: 6px 12px;
      font-size: 22px;
      font-weight: 600;
      color: #ffffff;
      border-radius: 6px;
      margin-bottom: 4px;
      transition: background 0.3s;
      align-items: center;
    }

    .entry span.place { 
      width: 30px; 
      text-align: center; 
      color: #bcd4ff; 
    }
    .entry span.place.gold { color: #ffd700; }
    .entry span.place.silver { color: #c0c0c0; }
    .entry span.place.bronze { color: #cd7f32; }

    .entry span.name { width: 290px; text-align: left; margin-left: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .entry span.elo { width: 65px; text-align: center; }
    .entry span.delta { width: 55px; text-align: center; display: flex; justify-content: center; align-items: center; }
    .delta-arrow { font-size: 0.6em; margin-right: 2px; display: inline-block; line-height: 1; }

    .entry.highlight { background: rgba(255, 255, 255, 0.15); }
    .delta-positive { color: #4ade80; }
    .delta-negative { color: #f87171; }

    .loading, .error { font-size: 16px; color: #aab6d9; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">Previous Match Results</div>
    <div id="resultsList"></div>
  </div>

<script>
  const API_URL = "https://rapid-haze-012c.nextweekmedia.workers.dev/get_rating_history";
  const CLIENT_ID = "DISCORD|1069003073311211601";
  const REFRESH_MS = 15000;

  const resultsEl = document.getElementById("resultsList");

  const urlParams = new URLSearchParams(window.location.search);
  const PLAYER_ID = urlParams.get('player_id');
  if (!PLAYER_ID) {
    resultsEl.innerHTML = '<div class="error">Missing player_id in URL</div>';
    throw new Error("Missing player_id in URL query");
  }

  let lastMatchHash = "";

  function setLoading() { resultsEl.innerHTML = '<div class="loading">Loading match results…</div>'; }
  function setError(msg) { resultsEl.innerHTML = `<div class="error">Error: ${msg}</div>`; console.error(msg); }

  function hashMatch(match) {
    if (!match || !match.ratingResults) return "";
    const newRatings = match.ratingResults[0].newRatings;
    return newRatings.map(p => `${p.id}:${p.place}:${p.elo}:${p.delta}`).join("|");
  }

  function displayResults(match, resolvedPlayers) {
    const newRatings = match.ratingResults[0].newRatings;
    resultsEl.innerHTML = ''; // clear previous

    newRatings.forEach(player => {
      const name = resolvedPlayers[player.id]?.display_name || "Unknown";

      // Conditional formatting for delta
      let arrowSpan = '';
      let deltaText = Math.abs(player.delta);
      let deltaClass = '';
      if (player.delta > 0) {
        arrowSpan = '<span class="delta-arrow">▲</span>';
        deltaClass = 'delta-positive';
      } else if (player.delta < 0) {
        arrowSpan = '<span class="delta-arrow">▼</span>';
        deltaClass = 'delta-negative';
      }

      // Conditional formatting for place
      let placeClass = '';
      if (player.place === 1) placeClass = 'gold';
      else if (player.place === 2) placeClass = 'silver';
      else if (player.place === 3) placeClass = 'bronze';

      const row = document.createElement("div");
      row.className = "entry";
      if (String(player.id) === String(PLAYER_ID)) row.classList.add("highlight");

      row.innerHTML = `
        <span class="place ${placeClass}">${player.place}</span>
        <span class="name">${name}</span>
        <span class="elo">${player.elo}</span>
        <span class="delta ${deltaClass}">${arrowSpan}${deltaText}</span>
      `;

      resultsEl.appendChild(row);
    });
  }

  async function fetchMatchResults() {
    try {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player_id: PLAYER_ID, client_id: CLIENT_ID, limit: 10 })
      });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      const matches = data.matches || [];
      const resolvedPlayers = data.resolved?.players || {};

      const recentMatch = matches
        .sort((a,b) => b.ts - a.ts)
        .find(match =>
          match.ratingResults.some(rg =>
            rg.newRatings.some(p => String(p.id) === String(PLAYER_ID))
          )
        );

      if (!recentMatch) {
        resultsEl.innerHTML = '<div class="loading">No recent match found for this player.</div>';
        return;
      }

      const currentHash = hashMatch(recentMatch);
      if (currentHash !== lastMatchHash) {
        lastMatchHash = currentHash;
        displayResults(recentMatch, resolvedPlayers);
      }

    } catch (err) {
      setError(err.message);
    }
  }

  fetchMatchResults();
  setInterval(fetchMatchResults, REFRESH_MS);
</script>
</body>
</html>
